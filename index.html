<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AI PYQ Bot (OpenRouter Edition)</title>

    <!-- Bootstrap for styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- MathJax Configuration -->
    <script>
        // Standard MathJax 3 Configuration
        MathJax = {
          tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']],
            displayMath: [['$$', '$$'], ['\\[', '\\]']],
            processEscapes: true
          },
          svg: {
            fontCache: 'global'
          },
          options: {
            skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            ignoreHtmlClass: 'tex2jax_ignore',
            processHtmlClass: 'tex2jax_process'
          },
          startup: {
            ready: () => {
              MathJax.startup.defaultReady();
            }
          }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

    <style>
        /* Same styles as before */
        body { padding-top: 20px; padding-bottom: 60px; }
        .screen { display: none; /* Hide all screens initially */ }
        #home-screen { display: block; /* Show home screen by default */ }
        .container { max-width: 800px; }
        .flash-message { margin-bottom: 15px; }
        .quiz-container, .config-container, .home-container { border: 1px solid #ccc; padding: 20px; margin-top: 20px; border-radius: 8px; background-color: #f9f9f9; }
        .options label { display: block; margin-bottom: 10px; }
        .results-review .card { margin-bottom: 15px; }
        .correct-text { color: green; font-weight: bold; }
        .incorrect-text { color: red; font-weight: bold; }
        .latex-math { line-height: 1.6; }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none; /* Hidden by default */
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .list-group-item.user-incorrect { background-color: #f8d7da; text-decoration: line-through; }
        .list-group-item.correct-answer { background-color: #d1e7dd; font-weight: bold; }
        .float-end { float: right; }
        .me-2 { margin-right: 0.5rem !important; }
    </style>
</head>
<body>
    <div class="container">
        <h1>AI PYQ & Question Bot <span class="badge bg-info text-dark">OpenRouter Edition</span></h1>
        <p class="text-muted small">Single-file version using OpenRouter. API key remains in your browser.</p>

        <!-- Alert Area -->
        <div id="alert-area"></div>

        <!-- 1. Home Screen (API Key / Base URL) -->
        <div id="home-screen" class="screen home-container">
            <h2>Step 1: Enter OpenRouter Credentials</h2>
            <p class="text-danger small"><strong>Warning:</strong> Your OpenRouter API key will be stored in browser session storage and sent directly from your browser. Use only in trusted environments.</p>
            <form id="home-form">
                <div class="mb-3">
                    <label for="api_key" class="form-label">OpenRouter API Key</label>
                    <input type="password" class="form-control" id="api_key" name="api_key" placeholder="sk-or-..." required>
                     <div class="form-text">Your key starting with 'sk-or-' from OpenRouter.ai.</div>
                </div>
                <div class="mb-3">
                    <label for="base_url" class="form-label">OpenRouter Base URL</label>
                    <input type="url" class="form-control" id="base_url" name="base_url" value="https://openrouter.ai/api" required>
                    <div class="form-text">Should generally be kept as `https://openrouter.ai/api`.</div>
                </div>
                 <div class="mb-3">
                    <label for="site_url" class="form-label">Your Site URL / Referer (Optional but Recommended)</label>
                    <input type="text" class="form-control" id="site_url" name="site_url" placeholder="e.g., http://localhost:8000/my-quiz-bot.html">
                    <div class="form-text">OpenRouter uses this for tracking. Enter the URL where you are running this file, or a name for your project.</div>
                </div>
                <button type="submit" class="btn btn-primary">Save & Continue</button>
            </form>
        </div>

        <!-- 2. Config Screen (Prompt, Number, Model) -->
        <div id="config-screen" class="screen config-container">
            <h2>Step 2: Configure Your Quiz</h2>
            <form id="config-form">
                <div class="mb-3">
                    <label for="prompt" class="form-label">Question Criteria</label>
                    <input type="text" class="form-control" id="prompt" name="prompt" placeholder="E.g., 'Most repeated questions of JEE mains Physics'" required>
                    <div class="form-text">Be specific! Mention exam, subject, topic, difficulty etc.</div>
                </div>
                <div class="mb-3">
                    <label for="num_questions" class="form-label">Number of Questions (1-25)</label>
                    <input type="number" class="form-control" id="num_questions" name="num_questions" min="1" max="25" value="5" required>
                </div>
                 <div class="mb-3">
                    <label for="model_name" class="form-label">OpenRouter Model Name (Required)</label>
                    <input type="text" class="form-control" id="model_name" name="model_name" placeholder="e.g., openai/gpt-3.5-turbo, anthropic/claude-3-haiku-20240307, google/gemini-pro" required>
                    <div class="form-text">Enter the exact model identifier from OpenRouter (format: `provider/model`). Check <a href="https://openrouter.ai/models" target="_blank" rel="noopener noreferrer">OpenRouter Models</a> for available options.</div>
                </div>
                <button type="submit" id="start-quiz-btn" class="btn btn-success">Generate & Start Quiz</button>
                <button type="button" id="change-api-btn" class="btn btn-secondary ms-2">Change API Key</button>
                <div id="loader" class="loader"></div>
            </form>
        </div>

        <!-- 3. Quiz Screen -->
        <div id="quiz-screen" class="screen">
            <div class="quiz-container">
                <h3 id="question-number">Question X of Y</h3>
                <hr>
                <p id="question-text" class="fs-5 latex-math">Loading question...</p>
                <form id="quiz-form">
                    <div id="options-container" class="options"></div>
                    <hr>
                    <button type="submit" class="btn btn-primary">Submit Answer</button>
                </form>
            </div>
            <div class="progress mt-3" role="progressbar" aria-label="Quiz progress" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
              <div id="progress-bar" class="progress-bar" style="width: 0%">0/0</div>
            </div>
            <div class="mt-3">
                <button type="button" id="quiz-restart-btn" class="btn btn-warning btn-sm">Restart Quiz (New Config)</button>
                <button type="button" id="quiz-start-over-btn" class="btn btn-secondary btn-sm">Start Over (New API Key)</button>
            </div>
        </div>

        <!-- 4. Results Screen -->
        <div id="results-screen" class="screen">
            <h2>Quiz Finished!</h2>
            <div id="score-summary" class="alert alert-info">Calculating score...</div>
            <div class="mt-4">
                <button type="button" id="results-restart-btn" class="btn btn-primary">Try Again (New Config)</button>
                <button type="button" id="results-start-over-btn" class="btn btn-secondary">Start Over (New API Key)</button>
            </div>
            <hr>
            <h3>Review Your Answers:</h3>
            <div id="results-review-container" class="results-review mt-3"></div>
        </div>

    </div> <!-- /container -->

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Main Application Logic -->
    <script>
        // State variables
        let apiKey = null;
        let baseUrl = "https://openrouter.ai/api"; // Default for OpenRouter
        let siteUrl = "http://localhost/ai-pyq-bot"; // Default Referer
        let questions = [];
        let currentQIndex = 0;
        let score = 0;
        let userAnswers = {};
        let modelName = '';
        let lastPrompt = '';
        let lastNumQuestions = 0;

        // DOM Elements (get references)
        const screens = document.querySelectorAll('.screen');
        const homeScreen = document.getElementById('home-screen');
        const configScreen = document.getElementById('config-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const resultsScreen = document.getElementById('results-screen');

        const homeForm = document.getElementById('home-form');
        const configForm = document.getElementById('config-form');
        const quizForm = document.getElementById('quiz-form');

        const apiKeyInput = document.getElementById('api_key');
        const baseUrlInput = document.getElementById('base_url');
        const siteUrlInput = document.getElementById('site_url'); // Referer input
        const promptInput = document.getElementById('prompt');
        const numQuestionsInput = document.getElementById('num_questions');
        const modelNameInput = document.getElementById('model_name');

        const startQuizBtn = document.getElementById('start-quiz-btn');
        const loader = document.getElementById('loader');
        const alertArea = document.getElementById('alert-area');

        const questionNumberEl = document.getElementById('question-number');
        const questionTextEl = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const progressBar = document.getElementById('progress-bar');

        const scoreSummaryEl = document.getElementById('score-summary');
        const resultsReviewContainer = document.getElementById('results-review-container');

        // --- Utility Functions ---

        function showAlert(message, type = 'danger') {
            alertArea.innerHTML = ''; // Clear previous
            const wrapper = document.createElement('div');
            wrapper.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show flash-message" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>`;
            alertArea.append(wrapper);
            window.scrollTo(0, 0);
        }

        function showScreen(screenId) {
            screens.forEach(screen => {
                screen.style.display = (screen.id === screenId) ? 'block' : 'none';
            });
        }

        function saveState() {
            sessionStorage.setItem('apiKey', apiKey || '');
            sessionStorage.setItem('baseUrl', baseUrl || 'https://openrouter.ai/api');
            sessionStorage.setItem('siteUrl', siteUrl || ''); // Save Referer/Site URL
            sessionStorage.setItem('modelName', modelName || '');
            sessionStorage.setItem('lastPrompt', lastPrompt || '');
            sessionStorage.setItem('lastNumQuestions', lastNumQuestions || 0);
            sessionStorage.setItem('questions', JSON.stringify(questions));
            sessionStorage.setItem('currentQIndex', currentQIndex);
            sessionStorage.setItem('score', score);
            sessionStorage.setItem('userAnswers', JSON.stringify(userAnswers));
             console.log("State Saved:", { apiKey: apiKey ? '******' : null, baseUrl, siteUrl, modelName, questions_count: questions.length, currentQIndex, score });
        }

        function loadState() {
            apiKey = sessionStorage.getItem('apiKey');
            baseUrl = sessionStorage.getItem('baseUrl') || "https://openrouter.ai/api"; // Default if not set
            siteUrl = sessionStorage.getItem('siteUrl') || ""; // Load saved Site URL
            modelName = sessionStorage.getItem('modelName') || '';
            lastPrompt = sessionStorage.getItem('lastPrompt') || '';
            lastNumQuestions = parseInt(sessionStorage.getItem('lastNumQuestions') || '0', 10);

            const storedQuestions = sessionStorage.getItem('questions');
            const storedAnswers = sessionStorage.getItem('userAnswers');

            questions = storedQuestions ? JSON.parse(storedQuestions) : [];
            currentQIndex = parseInt(sessionStorage.getItem('currentQIndex') || '0', 10);
            score = parseInt(sessionStorage.getItem('score') || '0', 10);
            userAnswers = storedAnswers ? JSON.parse(storedAnswers) : {};

            console.log("State Loaded:", { apiKey: apiKey ? '******' : null, baseUrl, siteUrl, modelName, questions_count: questions.length, currentQIndex, score });

            // Restore form fields
            if (apiKey) apiKeyInput.value = apiKey; // Typically avoid showing password fields
            baseUrlInput.value = baseUrl; // Set the Base URL input
            siteUrlInput.value = siteUrl; // Set the Site URL input
            if (modelName) modelNameInput.value = modelName;
            if (lastPrompt) promptInput.value = lastPrompt;
            if (lastNumQuestions > 0) numQuestionsInput.value = lastNumQuestions;
        }

        function resetQuizState() {
            questions = [];
            currentQIndex = 0;
            score = 0;
            userAnswers = {};
            sessionStorage.removeItem('questions');
            sessionStorage.removeItem('currentQIndex');
            sessionStorage.removeItem('score');
            sessionStorage.removeItem('userAnswers');
             console.log("Quiz state reset");
        }

        function clearAllState() {
             sessionStorage.clear();
             apiKey = null;
             baseUrl = "https://openrouter.ai/api"; // Reset to default
             siteUrl = ""; // Clear site URL
             modelName = '';
             lastPrompt = '';
             lastNumQuestions = 0;
             questions = [];
             currentQIndex = 0;
             score = 0;
             userAnswers = {};
             apiKeyInput.value = '';
             baseUrlInput.value = baseUrl; // Reset input field
             siteUrlInput.value = ''; // Clear input field
             promptInput.value = '';
             numQuestionsInput.value = 5;
             modelNameInput.value = '';
             console.log("All state cleared");
        }

        function renderMathJax() {
            if (window.MathJax && window.MathJax.typesetPromise) {
                 console.log("Requesting MathJax typesetting...");
                 MathJax.typesetPromise().then(() => {
                     console.log("MathJax typesetting complete.");
                 }).catch((err) => console.error('MathJax typesetting failed:', err));
             } else {
                 console.warn("MathJax not ready for typesetting yet.");
             }
        }

        function escapeHtml(unsafe) {
             if (typeof unsafe !== 'string') return unsafe;
             return unsafe.replace(/&/g, "&").replace(/</g, "<").replace(/>/g, ">").replace(/"/g, """).replace(/'/g, "'");
        }

        // --- AI Interaction (Modified for OpenRouter) ---
        async function generateQuestionsAI(prompt, numQuestions, currentModelName) {
            if (!apiKey || !baseUrl || !currentModelName) {
                showAlert("OpenRouter API Key, Base URL, and Model Name are required.", "warning");
                return null;
            }

            loader.style.display = 'block';
            startQuizBtn.disabled = true;
            startQuizBtn.textContent = 'Generating...';

            // OpenRouter endpoint (usually /v1/chat/completions)
            const apiEndpoint = `${baseUrl.replace(/\/$/, '')}/v1/chat/completions`;

            // === OpenRouter Specific Headers ===
            const headers = {
                "Authorization": `Bearer ${apiKey}`,
                "Content-Type": "application/json",
                "HTTP-Referer": siteUrl || "http://localhost/ai-pyq-bot", // Use entered siteUrl or a default
                "X-Title": "AI PYQ Bot", // Can be customized
            };

            // System prompt remains the same - tells the *model* what to do
            const aiSystemPrompt = `
You are an expert exam question generator... [Same detailed system prompt as before, instructing on PYQs, topics, LaTeX $\\int x^2 dx$, and STRICT JSON output format with keys: "question", "options" [list of 4 strings], "correct_answer" [string matching an option], "explanation" [optional string]] ... Generate exactly ${numQuestions} such objects in a JSON list. Ensure the output is *only* the JSON list.`;

            // Payload (OpenAI compatible, uses the OpenRouter model string)
            const payload = {
                model: currentModelName, // CRITICAL: Use the OpenRouter model name (e.g., "openai/gpt-3.5-turbo")
                messages: [
                    {"role": "system", "content": aiSystemPrompt},
                    {"role": "user", "content": `Generate the ${numQuestions} questions now based on the system instructions regarding: ${prompt}`}
                ],
                max_tokens: 3500, // Generous limit for questions+explanations
                temperature: 0.5,
                response_format: { "type": "json_object" } // Request JSON mode if model supports it
            };

            console.log("Sending request to OpenRouter:", apiEndpoint);
             console.log("Headers:", JSON.stringify({...headers, Authorization: 'Bearer ******'})); // Log headers (mask key)
             console.log("Payload:", JSON.stringify(payload).substring(0, 300) + "..."); // Log truncated payload

            try {
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(payload),
                    // mode: 'cors' // Browser fetch usually handles this automatically
                });

                console.log("OpenRouter Response Status:", response.status);

                if (!response.ok) {
                    let errorBody = await response.text();
                    try { errorBody = JSON.stringify(JSON.parse(errorBody), null, 2); } catch(e) { /* Ignore if not JSON */ }
                    // Include specific OpenRouter info if available (e.g., in headers or body)
                    throw new Error(`OpenRouter API request failed: ${response.status} ${response.statusText}. Response: ${errorBody}`);
                }

                const data = await response.json();
                console.log("OpenRouter Raw Response Data:", data);

                // --- Parse the Response (Should be OpenAI compatible) ---
                let messageContent = '';
                if (data.choices && data.choices.length > 0 && data.choices[0].message) {
                     messageContent = data.choices[0].message.content;
                } else {
                     throw new Error("Unexpected OpenRouter response structure. 'choices' array not found or empty.");
                }

                console.log("AI Message Content String:", messageContent.substring(0, 500) + "...");

                if (!messageContent) {
                    throw new Error("OpenRouter response was empty.");
                }

                let generatedQuestions = null;
                try {
                     // Attempt to remove potential markdown ```json ... ``` wrappers
                    const jsonMatch = messageContent.match(/```json\s*([\s\S]*?)\s*```/);
                    if(jsonMatch && jsonMatch[1]){
                        console.log("Detected markdown JSON block, extracting content.");
                        messageContent = jsonMatch[1];
                    }
                    generatedQuestions = JSON.parse(messageContent);
                } catch (e) {
                    console.error("JSON Parsing Error:", e);
                    throw new Error(`Failed to decode OpenRouter response as JSON. Check the model's output format. Raw content started with: ${messageContent.substring(0, 200)}...`);
                }

                // --- Validate the parsed structure (same validation logic) ---
                 if (!Array.isArray(generatedQuestions)) throw new Error("Expected a JSON list (array).");
                 if (generatedQuestions.length === 0) throw new Error("Returned an empty list of questions.");

                 const validatedQuestions = [];
                 for (let i = 0; i < generatedQuestions.length; i++) {
                     const q = generatedQuestions[i];
                      if (q && typeof q === 'object' &&
                          q.question && typeof q.question === 'string' &&
                          q.options && Array.isArray(q.options) && q.options.length === 4 && q.options.every(opt => typeof opt === 'string') &&
                          q.correct_answer && typeof q.correct_answer === 'string' &&
                          q.options.includes(q.correct_answer)
                          // explanation is optional
                      ) {
                         validatedQuestions.push(q);
                     } else {
                         console.warn(`Skipping invalid question structure at index ${i}:`, q);
                     }
                 }

                 if (validatedQuestions.length === 0) {
                      throw new Error("Returned questions, but none had the required valid structure (question, options[4], correct_answer).");
                 }
                 if (validatedQuestions.length < numQuestions) {
                      showAlert(`Generated ${validatedQuestions.length} valid questions (requested ${numQuestions}). Proceeding with available questions.`, 'warning');
                 }

                return validatedQuestions.slice(0, numQuestions);

            } catch (error) {
                console.error("Error interacting with OpenRouter:", error);
                // Provide more specific advice if possible
                 let userMessage = `Error generating questions: ${error.message}`;
                 if (error.message && error.message.includes('401')) {
                     userMessage += " Check your OpenRouter API Key.";
                 } else if (error.message && (error.message.includes('400') || error.message.includes('model_not_found'))) {
                     userMessage += " Check if the Model Name is correct and available on OpenRouter.";
                 } else if (error.message && error.message.includes('429')) {
                      userMessage += " You might have hit OpenRouter rate limits or quota.";
                 }
                 showAlert(userMessage, "danger");
                return null;
            } finally {
                loader.style.display = 'none';
                startQuizBtn.disabled = false;
                startQuizBtn.textContent = 'Generate & Start Quiz';
            }
        }

        // --- UI Rendering Functions (displayQuestion, displayResults) ---
        // NO CHANGES needed in displayQuestion or displayResults logic itself.
        // They correctly use the `questions`, `currentQIndex`, `score`, `userAnswers` state variables
        // and call `renderMathJax()`.

        function displayQuestion() {
             if (currentQIndex >= questions.length) {
                console.log("Quiz finished, showing results.");
                displayResults();
                showScreen('results-screen');
                return;
            }
            const qData = questions[currentQIndex];
            questionNumberEl.textContent = `Question ${currentQIndex + 1} of ${questions.length}`;
            questionTextEl.textContent = qData.question; // Use textContent for safety before MathJax

            optionsContainer.innerHTML = '';
            qData.options.forEach((option, index) => {
                const div = document.createElement('div');
                div.classList.add('form-check');
                div.innerHTML = `
                    <input class="form-check-input" type="radio" name="option" id="option${index}" value="${escapeHtml(option)}" required>
                    <label class="form-check-label latex-math" for="option${index}">
                        ${option}
                    </label>`;
                optionsContainer.appendChild(div);
            });

            const progressPercent = ((currentQIndex + 1) / questions.length) * 100;
            progressBar.style.width = `${progressPercent}%`;
            progressBar.textContent = `${currentQIndex + 1}/${questions.length}`;
            progressBar.setAttribute('aria-valuenow', progressPercent);

            renderMathJax(); // IMPORTANT
             console.log(`Displayed question ${currentQIndex + 1}`);
        }

         function displayResults() {
            const totalQuestions = questions.length;
            if (totalQuestions === 0) {
                scoreSummaryEl.textContent = "No questions were answered.";
                resultsReviewContainer.innerHTML = "<p>No results to display.</p>";
                return;
            }
            const percentage = ((score / totalQuestions) * 100).toFixed(2);
            scoreSummaryEl.innerHTML = `Your Score: <strong>${score}</strong> out of <strong>${totalQuestions}</strong> (${percentage}%)`;

            resultsReviewContainer.innerHTML = '';
            questions.forEach((q, index) => {
                const userAnswer = userAnswers[index];
                const isCorrect = userAnswer === q.correct_answer;
                const card = document.createElement('div');
                card.classList.add('card');
                 card.innerHTML = `
                    <div class="card-header">
                        Question ${index + 1} ${isCorrect ? '<span class="badge bg-success float-end">Correct</span>' : (userAnswer ? '<span class="badge bg-danger float-end">Incorrect</span>' : '<span class="badge bg-warning float-end">Not Answered</span>')}
                    </div>
                    <div class="card-body">
                        <p class="card-text latex-math"><strong>Q:</strong> ${q.question}</p>
                        <ul class="list-group list-group-flush">
                            ${q.options.map(option => `
                                <li class="list-group-item latex-math
                                    ${option === q.correct_answer ? 'correct-answer' : ''}
                                    ${option === userAnswer && !isCorrect ? 'user-incorrect' : ''}">
                                    ${option}
                                    ${option === q.correct_answer ? '<span class="badge bg-success-subtle text-success-emphasis float-end">Correct Answer</span>' : ''}
                                    ${option === userAnswer ? '<span class="badge bg-primary-subtle text-primary-emphasis float-end me-2">Your Answer</span>' : ''}
                                </li>`).join('')}
                        </ul>
                        <div class="mt-3">
                             ${!isCorrect && userAnswer ? `<p><span class="incorrect-text">Your answer "${escapeHtml(userAnswer)}" was incorrect.</span></p>` : ''}
                             ${!isCorrect ? `<p><strong>Correct Answer:</strong> <span class="latex-math">${q.correct_answer}</span></p>` : ''}
                             ${isCorrect ? `<p><span class="correct-text">Your answer was correct!</span></p>` : ''}
                             ${q.explanation ? `<p><strong>Explanation:</strong> <span class="latex-math">${q.explanation}</span></p>` : '<p><em>No explanation provided.</em></p>'}
                        </div>
                    </div>`;
                resultsReviewContainer.appendChild(card);
            });
            renderMathJax(); // IMPORTANT
             console.log("Displayed results.");
        }

        // --- Event Listeners ---

        homeForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const key = apiKeyInput.value.trim();
            const url = baseUrlInput.value.trim();
            const refUrl = siteUrlInput.value.trim(); // Get Referer URL

            if (!key || !url) {
                showAlert("OpenRouter API Key and Base URL are required.", "warning");
                return;
            }
             if (!key.startsWith('sk-or-')) {
                 showAlert("OpenRouter API Key should start with 'sk-or-'.", "warning");
             }
             if (!url.startsWith('https://openrouter.ai/api')) {
                 showAlert("Base URL should typically be 'https://openrouter.ai/api'.", "warning");
                 // Allow override but warn
             }

            apiKey = key;
            baseUrl = url;
            siteUrl = refUrl || "http://localhost/ai-pyq-bot"; // Use entered or default
            saveState();
            showAlert("OpenRouter credentials saved for this session.", "success");
            showScreen('config-screen');
        });

        configForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const prompt = promptInput.value.trim();
            const numQuestions = parseInt(numQuestionsInput.value, 10);
            const currentModelName = modelNameInput.value.trim();

            if (!prompt || !numQuestions || !currentModelName) {
                showAlert("Prompt, number of questions, and OpenRouter Model Name are required.", "warning");
                return;
            }
            if (numQuestions < 1 || numQuestions > 25) {
                 showAlert("Number of questions must be between 1 and 25.", "warning"); return;
            }
            // Basic check for OpenRouter model format (optional but helpful)
             if (!currentModelName.includes('/')) {
                 showAlert("OpenRouter Model Name should be in 'provider/model' format (e.g., 'openai/gpt-3.5-turbo').", "warning");
             }


            modelName = currentModelName;
            lastPrompt = prompt;
            lastNumQuestions = numQuestions;
            resetQuizState();
            saveState(); // Save config before async call

            const generatedQuestions = await generateQuestionsAI(prompt, numQuestions, currentModelName);

            if (generatedQuestions && generatedQuestions.length > 0) {
                questions = generatedQuestions;
                currentQIndex = 0;
                score = 0;
                userAnswers = {};
                saveState(); // Save generated questions
                showAlert(`Generated ${questions.length} questions using ${modelName}. Starting quiz!`, "success");
                displayQuestion();
                showScreen('quiz-screen');
            } else {
                // Error shown by generateQuestionsAI
                console.error("Failed to generate/validate questions from OpenRouter.");
            }
        });

        quizForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const selectedOptionInput = quizForm.querySelector('input[name="option"]:checked');
            if (!selectedOptionInput) {
                showAlert("Please select an answer.", "warning"); return;
            }

            const userAnswer = selectedOptionInput.value;
            const correctAnswer = questions[currentQIndex].correct_answer;
            userAnswers[currentQIndex] = userAnswer;
            if (userAnswer === correctAnswer) { score++; }

             console.log(`Q${currentQIndex + 1} Answered. Correct: ${userAnswer === correctAnswer}. Score: ${score}`);

            currentQIndex++;
            saveState();
            displayQuestion(); // Next question or results
        });

        // --- Navigation/Restart Button Listeners (No changes needed) ---
         document.getElementById('change-api-btn').addEventListener('click', () => showScreen('home-screen'));
         document.getElementById('quiz-restart-btn').addEventListener('click', () => { resetQuizState(); saveState(); showScreen('config-screen'); });
         document.getElementById('results-restart-btn').addEventListener('click', () => { resetQuizState(); saveState(); showScreen('config-screen'); });
         document.getElementById('quiz-start-over-btn').addEventListener('click', () => { clearAllState(); showScreen('home-screen'); });
         document.getElementById('results-start-over-btn').addEventListener('click', () => { clearAllState(); showScreen('home-screen'); });

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Loaded. Initializing OpenRouter PYQ Bot.");
            loadState(); // Load saved state including OpenRouter specific fields

             // Determine initial screen based on loaded state
            if (apiKey && baseUrl) { // Check for essential credentials
                if (questions && questions.length > 0 && currentQIndex < questions.length) {
                     console.log("Resuming quiz.");
                     displayQuestion();
                     showScreen('quiz-screen');
                } else if (questions && questions.length > 0 && currentQIndex >= questions.length) {
                    console.log("Showing previous results.");
                    displayResults();
                    showScreen('results-screen');
                } else {
                    console.log("Credentials found, showing config screen.");
                    showScreen('config-screen');
                }
            } else {
                 console.log("No credentials found, showing home screen.");
                showScreen('home-screen');
            }
             renderMathJax(); // Initial render just in case
        });

    </script>

</body>
</html>
