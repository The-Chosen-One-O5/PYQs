<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PYQ Bot - Powered by OpenRouter</title>
    <!-- KaTeX for LaTeX rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/auto-render.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        label {
            font-weight: bold;
        }
        input, button {
            padding: 10px;
            font-size: 16px;
        }
        button {
            background-color: #007BFF;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .question {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        #questions-container {
            margin-top: 20px;
        }
        #loading {
            text-align: center;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Homescreen Section -->
        <div id="home" class="section active">
            <h1>Welcome to PYQ Bot!</h1>
            <form id="api-form">
                <label for="api-key">Enter Your OpenRouter API Key:</label>
                <input type="text" id="api-key" required>
                <button type="submit">Proceed</button>
            </form>
            <p><small>Get your API key from <a href="https://openrouter.ai" target="_blank">OpenRouter</a>.</small></p>
        </div>

        <!-- Customization Section -->
        <div id="customize" class="section">
            <h1>Customize Your Questions</h1>
            <form id="customize-form">
                <label for="question-type">What kind of questions?</label>
                <input type="text" id="question-type" placeholder="e.g., Most repeated questions of JEE Mains" required>
                
                <label for="num-questions">Number of Questions (Max 25):</label>
                <input type="number" id="num-questions" min="1" max="25" required>
                
                <label for="model-name">Model Name:</label>
                <input type="text" id="model-name" placeholder="e.g., xai/grok" required>
                
                <button type="submit">Start</button>
            </form>
            <p><small>Available models: <a href="https://openrouter.ai/models" target="_blank">OpenRouter Models</a></small></p>
        </div>

        <!-- Solver Section -->
        <div id="solver" class="section">
            <h1>Your Custom Questions</h1>
            <div id="loading">Loading questions...</div>
            <div id="questions-container"></div>
            <button id="back-btn">Back to Customize</button>
        </div>
    </div>

    <script>
        let apiKey = '';

        // Show/hide sections
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
        }

        // Handle API form submission
        document.getElementById('api-form').addEventListener('submit', function(e) {
            e.preventDefault();
            apiKey = document.getElementById('api-key').value;
            showSection('customize');
        });

        // Handle customization form submission
        document.getElementById('customize-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const questionType = document.getElementById('question-type').value;
            const numQuestions = parseInt(document.getElementById('num-questions').value);
            const modelName = document.getElementById('model-name').value;

            // Show loading message
            showSection('solver');
            document.getElementById('loading').style.display = 'block';
            document.getElementById('questions-container').innerHTML = '';

            // Generate questions
            const questions = await generateQuestions(questionType, numQuestions, modelName);
            document.getElementById('loading').style.display = 'none';
            displayQuestions(questions);
        });

        // Back button
        document.getElementById('back-btn').addEventListener('click', function() {
            showSection('customize');
        });

        // Generate questions using OpenRouter API
        async function generateQuestions(questionType, numQuestions, modelName) {
            const url = 'https://openrouter.ai/api/v1/chat/completions';
            const prompt = `
                Generate ${numQuestions} multiple-choice questions (MCQs) based on: "${questionType}". 
                Each question must have:
                - A question stem.
                - Exactly 4 options labeled A, B, C, D.
                - The correct answer.
                Format each question as a JSON object in an array. Use LaTeX (e.g., $...$ or $$...$$) for mathematical equations where applicable. 
                If PYQs are requested (e.g., JEE Mains, BITSAT), ensure questions are based on real previous year questions or closely mimic them. 
                Do not generate random unrelated questions.
            `;

            const payload = {
                model: modelName,
                messages: [{ role: 'user', content: prompt }],
                max_tokens: 2000,
                temperature: 0.7
            };
            const headers = {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/json',
                'HTTP-Referer': window.location.href,
                'X-Title': 'PYQ Bot'
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! Status: ${response.status}, Details: ${errorText}`);
                }

                const data = await response.json();
                console.log('API Response:', data); // Log the full response for debugging

                // Check if choices exists and has at least one item
                if (!data.choices || !Array.isArray(data.choices) || data.choices.length === 0) {
                    throw new Error('Invalid response format: No choices found');
                }

                const content = data.choices[0].message.content;
                if (!content) {
                    throw new Error('No content in response');
                }

                // Parse the JSON content
                let questions;
                try {
                    questions = JSON.parse(content);
                } catch (parseError) {
                    throw new Error(`Failed to parse JSON: ${content}`);
                }

                // Validate and transform the questions
                if (!Array.isArray(questions)) {
                    throw new Error('Response is not an array of questions');
                }

                return questions.map(q => ({
                    question: q.question || 'Missing question',
                    options: [q.A, q.B, q.C, q.D].filter(opt => opt !== undefined), // Ensure all options exist
                    answer: q.answer || 'No answer provided'
                }));
            } catch (error) {
                console.error('Error:', error);
                return [{ question: `Error: ${error.message}`, options: [], answer: '' }];
            }
        }

        // Display questions in solver section
        function displayQuestions(questions) {
            const container = document.getElementById('questions-container');
            container.innerHTML = '';
            questions.forEach((q, index) => {
                const div = document.createElement('div');
                div.className = 'question';
                div.innerHTML = `
                    <p>${index + 1}. ${q.question}</p>
                    <ul>
                        ${q.options.map((opt, i) => `<li>${String.fromCharCode(65 + i)}. ${opt}</li>`).join('')}
                    </ul>
                    <p><strong>Answer:</strong> ${q.answer}</p>
                `;
                container.appendChild(div);
            });

            // Render LaTeX
            renderMathInElement(container, {
                delimiters: [
                    { left: "$$", right: "$$", display: true },
                    { left: "$", right: "$", display: false }
                ]
            });
        }
    </script>
</body>
</html>
