<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI PYQs Bot (DeepSeek/OpenRouter)</title>

    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>

    <script>
        window.MathJax = {
          tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']],
            displayMath: [['$$', '$$'], ['\\[', '\\]']]
          },
          svg: {
            fontCache: 'global'
          }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        .hidden-element { display: none; }
        .option-button { transition: background-color 0.2s ease, transform 0.1s ease, border-color 0.2s ease; }
        .option-button:not(:disabled):hover { background-color: #e5e7eb; border-color: #9ca3af; }
        .option-button:not(:disabled):active { transform: scale(0.98); }
        .correct-answer { background-color: #10b981 !important; color: white !important; border-color: #059669 !important; }
        .incorrect-answer { background-color: #ef4444 !important; color: white !important; border-color: #dc2626 !important; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        mjx-container { overflow-x: auto; overflow-y: hidden; display: block; margin: 0.5rem 0; padding: 2px; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #4f46e5; animation: spin 1s ease infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #question-text, #explanation-text, .option-button { word-wrap: break-word; overflow-wrap: break-word; }
        select { appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2220%22%20height%3D%2220%22%20fill%3D%22none%22%20stroke%3D%22%236b7280%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%20stroke-width%3D%221.5%22%20viewBox%3D%220%200%2024%2024%22%3E%3Cpath%20d%3D%22M6%209l6%206%206-6%22%2F%3E%3C%2Fsvg%3E'); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; }
    </style>

</head>
<body class="flex items-center justify-center min-h-screen bg-gradient-to-br from-indigo-100 via-purple-100 to-pink-100 p-4">

    <div class="container mx-auto max-w-2xl w-full bg-white rounded-xl shadow-2xl overflow-hidden">

        <div id="setup-page" class="p-6 md:p-10 transition-all duration-500">
            <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">AI PYQs Bot Setup</h1>
            <p class="text-center text-gray-600 mb-8">Select your AI provider and enter details.</p>
            <div class="space-y-5">
                <div>
                    <label for="apiProvider" class="block text-sm font-medium text-gray-700 mb-1">AI Provider</label>
                    <select id="apiProvider" name="apiProvider" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out bg-white">
                        <option value="deepseek" selected>DeepSeek</option>
                        <option value="openrouter">OpenRouter</option>
                    </select>
                </div>
                <div>
                    <label for="apiKey" class="block text-sm font-medium text-gray-700 mb-1">API Key <span class="text-red-500">*</span></label>
                    <input type="password" id="apiKey" name="apiKey" placeholder="Enter your API Key" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out">
                    <p class="mt-1 text-xs text-gray-500">Stored temporarily in browser session. <strong class="text-red-600">Handle with care.</strong></p>
                </div>
                <div>
                    <label for="baseUrl" class="block text-sm font-medium text-gray-700 mb-1">Base URL (Optional)</label>
                    <input type="url" id="baseUrl" name="baseUrl" placeholder="Default: https://api.deepseek.com/v1" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out">
                     <p class="mt-1 text-xs text-gray-500">Leave blank for default or enter custom endpoint/proxy.</p>
                </div>
                <div id="openrouter-model-container" class="hidden-element">
                    <label for="openRouterModel" class="block text-sm font-medium text-gray-700 mb-1">OpenRouter Model Name <span class="text-red-500">*</span></label>
                    <input type="text" id="openRouterModel" name="openRouterModel" placeholder="e.g., google/gemini-flash, anthropic/claude-3-haiku" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out">
                    <p class="mt-1 text-xs text-gray-500">Specify the exact model to use via OpenRouter.</p>
                </div>
                 <div id="setup-error" class="text-red-600 text-sm hidden-element font-medium text-center p-2 bg-red-50 rounded-md border border-red-200"></div>
                <button id="submit-setup" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-md shadow-md transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Continue to Customization</button>
            </div>
        </div>

        <div id="customization-page" class="hidden-element p-6 md:p-10 transition-all duration-500">
             <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">Customize Your Quiz</h1>
            <p class="text-center text-gray-600 mb-8">Describe the questions you need. Be specific!</p>
            <div class="space-y-5">
                <div>
                    <label for="questionPrompt" class="block text-sm font-medium text-gray-700 mb-1">Question Prompt <span class="text-red-500">*</span></label>
                    <textarea id="questionPrompt" name="questionPrompt" rows="4" placeholder="E.g., '5 most repeated PYQs from JEE Mains Physics (Kinematics)', 'Easy difficulty Thermodynamics questions for NEET UG', 'Hard level questions on Nucleophilic Substitution from Alkyl Halides for JEE Advanced'" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out"></textarea>
                     <p class="mt-1 text-xs text-gray-500">Mention exam, subject, topic, difficulty, PYQs if needed.</p>
                </div>
                <div>
                    <label for="numQuestions" class="block text-sm font-medium text-gray-700 mb-1">Number of Questions (1-25) <span class="text-red-500">*</span></label>
                    <input type="number" id="numQuestions" name="numQuestions" min="1" max="25" value="5" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out">
                </div>
                 <div id="customization-error" class="text-red-600 text-sm hidden-element font-medium text-center p-2 bg-red-50 rounded-md border border-red-200"></div>
                <button id="start-quiz" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md shadow-md transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">Generate & Start Quiz</button>
                 <button id="back-to-setup" class="w-full mt-2 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">Back to API Setup</button>
            </div>
             <div id="loading-indicator" class="hidden-element mt-6 text-center">
                <p id="loading-text" class="text-indigo-600 font-semibold mb-3">Generating questions...</p>
                <div class="spinner mx-auto"></div>
                <p class="text-sm text-gray-500 mt-3">This may take a few moments, please wait.</p>
            </div>
        </div>

        <div id="quiz-page" class="hidden-element p-6 md:p-10 transition-all duration-500">
             <div class="flex justify-between items-center mb-5 border-b pb-3 border-gray-200">
                <h2 class="text-2xl font-bold text-gray-800">Quiz Time!</h2>
                 <button id="exit-quiz" title="Exit Quiz" class="text-sm bg-red-100 hover:bg-red-200 text-red-700 font-semibold py-1 px-3 rounded-md shadow-sm transition duration-300 border border-red-200">Exit</button>
            </div>
            <div class="mb-6">
                <div class="flex justify-between mb-1">
                    <span class="text-sm font-medium text-indigo-700">Progress</span>
                    <span id="progress-text" class="text-sm font-medium text-indigo-700">Question 1 / 10</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
                    <div id="progress-bar" class="bg-gradient-to-r from-indigo-500 to-purple-500 h-2.5 rounded-full transition-all duration-500 ease-out" style="width: 10%"></div>
                </div>
            </div>
            <div id="question-container" class="mb-6 p-5 border border-gray-200 rounded-lg bg-gray-50 min-h-[120px] shadow-sm">
                <p id="question-text" class="text-lg text-gray-900 leading-relaxed">Loading question...</p>
            </div>
            <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"></div>
            <div id="feedback-container" class="min-h-[60px] mb-6">
                 <p id="feedback-text" class="text-center font-semibold text-xl"></p>
                 <div id="explanation-area" class="mt-3 p-4 bg-blue-50 border border-blue-200 rounded-lg text-sm text-gray-800 hidden-element shadow-sm">
                     <strong class="text-blue-800 block mb-1 text-base">Explanation:</strong>
                     <div id="explanation-text" class="leading-relaxed"></div>
                 </div>
            </div>
            <div class="flex justify-between items-center pt-4 border-t border-gray-200">
                <button id="prev-button" disabled class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-md shadow transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">Previous</button>
                <button id="next-button" disabled class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-md shadow transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
                <button id="finish-button" disabled class="hidden-element bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-md shadow transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">Finish Quiz</button>
            </div>
        </div>

        <div id="results-page" class="hidden-element p-8 md:p-12 rounded-lg text-center">
             <svg class="w-16 h-16 mx-auto text-green-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <h2 class="text-3xl font-bold text-gray-800 mb-4">Quiz Completed!</h2>
            <p class="text-xl text-gray-700 mb-8">Your Score: <span id="final-score" class="font-bold text-indigo-600 text-2xl">0 / 0</span></p>
            <div class="space-y-3 md:space-y-0 md:space-x-4 flex flex-col md:flex-row justify-center">
                 <button id="restart-quiz" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-6 rounded-md shadow transition duration-300">Restart with Same Settings</button>
                 <button id="new-quiz" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2.5 px-6 rounded-md shadow transition duration-300">Start New Quiz</button>
            </div>
        </div>


    </div> <script>
        // --- DOM Elements (Same as before) ---
        const setupPage = document.getElementById('setup-page');
        const customizationPage = document.getElementById('customization-page');
        const quizPage = document.getElementById('quiz-page');
        const resultsPage = document.getElementById('results-page');
        const apiProviderSelect = document.getElementById('apiProvider');
        const apiKeyInput = document.getElementById('apiKey');
        const baseUrlInput = document.getElementById('baseUrl');
        const openRouterModelContainer = document.getElementById('openrouter-model-container');
        const openRouterModelInput = document.getElementById('openRouterModel');
        const submitSetupButton = document.getElementById('submit-setup');
        const setupError = document.getElementById('setup-error');
        const questionPromptInput = document.getElementById('questionPrompt');
        const numQuestionsInput = document.getElementById('numQuestions');
        const startQuizButton = document.getElementById('start-quiz');
        const backToSetupButton = document.getElementById('back-to-setup');
        const customizationError = document.getElementById('customization-error');
        const loadingIndicator = document.getElementById('loading-indicator');
        const loadingText = document.getElementById('loading-text');
        const questionTextElement = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const feedbackTextElement = document.getElementById('feedback-text');
        const explanationArea = document.getElementById('explanation-area');
        const explanationTextElement = document.getElementById('explanation-text');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const finishButton = document.getElementById('finish-button');
        const exitQuizButton = document.getElementById('exit-quiz');
        const progressTextElement = document.getElementById('progress-text');
        const progressBarElement = document.getElementById('progress-bar');
        const finalScoreElement = document.getElementById('final-score');
        const restartQuizButton = document.getElementById('restart-quiz');
        const newQuizButton = document.getElementById('new-quiz');

        // --- State Variables (Same as before) ---
        let apiKey = '';
        let baseUrl = '';
        let selectedProvider = 'deepseek';
        let modelName = '';
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let score = 0;
        let quizSettings = { provider: '', model: '', prompt: '', numQuestions: 0 };

        // --- Constants (Same as before) ---
        const DEEPSEEK_DEFAULT_BASE_URL = 'https://api.deepseek.com/v1';
        const DEEPSEEK_DEFAULT_MODEL = 'deepseek-chat';
        const OPENROUTER_DEFAULT_BASE_URL = 'https://openrouter.ai/api/v1';
        const OPENROUTER_REFERER_URL = 'http://localhost/ai-pyq-bot'; // Replace if deploying
        const OPENROUTER_APP_NAME = 'AI-PYQ-Bot'; // Replace if deploying

        // --- Helper Functions (showPage, displayError, hideError - Same as before) ---
        function showPage(pageId) { [setupPage, customizationPage, quizPage, resultsPage].forEach(page => { page.classList.toggle('hidden-element', page.id !== pageId); }); window.scrollTo(0, 0); }
        function displayError(element, message) { element.textContent = message; element.classList.remove('hidden-element'); }
        function hideError(element) { element.textContent = ''; element.classList.add('hidden-element'); }

        // --- Setup Page Logic (Same as before) ---
        function updateSetupUI() { selectedProvider = apiProviderSelect.value; console.log("Provider selected:", selectedProvider); if (selectedProvider === 'openrouter') { openRouterModelContainer.classList.remove('hidden-element'); baseUrlInput.placeholder = `Default: ${OPENROUTER_DEFAULT_BASE_URL}`; } else { openRouterModelContainer.classList.add('hidden-element'); baseUrlInput.placeholder = `Default: ${DEEPSEEK_DEFAULT_BASE_URL}`; } hideError(setupError); }
        apiProviderSelect.addEventListener('change', updateSetupUI);
        submitSetupButton.addEventListener('click', () => { hideError(setupError); let isValid = true; const key = apiKeyInput.value.trim(); if (!key) { displayError(setupError, "API Key is required."); apiKeyInput.focus(); isValid = false; } else { apiKey = key; } if (selectedProvider === 'openrouter') { const orModel = openRouterModelInput.value.trim(); if (!orModel) { displayError(setupError, "OpenRouter Model Name is required."); openRouterModelInput.focus(); isValid = false; } else { modelName = orModel; } } else { modelName = DEEPSEEK_DEFAULT_MODEL; } baseUrl = baseUrlInput.value.trim(); if (isValid) { console.log("Setup Complete:", { provider: selectedProvider, model: modelName, apiKey: '***', baseUrl: baseUrl || '(Default)' }); showPage('customization-page'); } });

        // --- API Call Logic ---

        // Function to parse the AI response and validate questions
        function parseAndValidateApiResponse(aiContent, numQuestionsRequested) {
            const trimmedContent = aiContent.trim();

            // --- ** New Check: Does it start/end with array brackets? ** ---
            if (!trimmedContent.startsWith('[') || !trimmedContent.endsWith(']')) {
                 console.error("AI response does not start with '[' and end with ']'. Format violation.");
                 console.error("--- Raw AI Content Start ---");
                 console.error(trimmedContent);
                 console.error("--- Raw AI Content End ---");
                 throw new Error("AI response format error: Response did not start and end with the expected JSON array brackets ('[]'). Check console log for raw AI output.");
            }

            let parsedQuestions;
            try {
                // Attempt to parse the trimmed content
                parsedQuestions = JSON.parse(trimmedContent);
            } catch (parseError) {
                console.error("JSON Parsing Error:", parseError);
                console.error("--- Raw AI Content Start ---");
                console.error(trimmedContent); // Log the exact string that failed
                console.error("--- Raw AI Content End ---");
                throw new Error(`AI response format error: Could not parse content as JSON, even though it started/ended with brackets. Check console log for raw AI output. Error: ${parseError.message}`);
            }

            // --- Validation (Same as before) ---
            if (!Array.isArray(parsedQuestions)) { throw new Error("AI response format error: Parsed content is not a JSON array."); }
            const validatedQuestions = parsedQuestions.map((q, index) => { /* ... validation logic ... */ if (typeof q !== 'object' || q === null || typeof q.question !== 'string' || !q.question.trim() || !Array.isArray(q.options) || q.options.length < 2 || typeof q.correctAnswerIndex !== 'number' || !Number.isInteger(q.correctAnswerIndex) || q.correctAnswerIndex < 0 || q.correctAnswerIndex >= q.options.length || typeof q.explanation !== 'string') { console.warn(`Skipping question at index ${index} due to invalid format or missing fields:`, q); return null; } const validOptions = q.options.every(opt => typeof opt === 'string' && opt.trim()); if (!validOptions) { console.warn(`Skipping question at index ${index} due to invalid or empty options:`, q.options); return null; } return { question: q.question.trim(), options: q.options.map(opt => String(opt).trim()), correctAnswerIndex: q.correctAnswerIndex, explanation: q.explanation.trim() || "No explanation provided." }; }).filter(q => q !== null);
            if (validatedQuestions.length === 0) { throw new Error("AI returned content, but no questions were in the expected valid JSON format after parsing."); }
            console.log(`Successfully validated ${validatedQuestions.length} questions.`);
            if (validatedQuestions.length < numQuestionsRequested) { console.warn(`AI returned only ${validatedQuestions.length} valid questions out of ${numQuestionsRequested} requested.`); }
            return validatedQuestions.slice(0, numQuestionsRequested);
        }


        // Main function to fetch questions from the selected provider
        async function fetchQuestions(prompt, numQuestions) {
            const providerName = selectedProvider === 'openrouter' ? 'OpenRouter' : 'DeepSeek';
            console.log(`Fetching ${numQuestions} questions from ${providerName} API...`);
            loadingText.textContent = `Generating questions via ${providerName} API...`;
            loadingIndicator.classList.remove('hidden-element');
            startQuizButton.disabled = true;
            hideError(customizationError);

            let apiUrl = '';
            let headers = { 'Content-Type': 'application/json' };
            let requestBody = {};

            // Configure API details based on provider
            if (selectedProvider === 'openrouter') {
                apiUrl = (baseUrl || OPENROUTER_DEFAULT_BASE_URL).replace(/\/$/, '') + '/chat/completions';
                headers['Authorization'] = `Bearer ${apiKey}`;
                headers['HTTP-Referer'] = OPENROUTER_REFERER_URL;
                headers['X-Title'] = OPENROUTER_APP_NAME;
                requestBody.model = modelName;
            } else { // deepseek
                apiUrl = (baseUrl || DEEPSEEK_DEFAULT_BASE_URL).replace(/\/$/, '') + '/chat/completions';
                headers['Authorization'] = `Bearer ${apiKey}`;
                requestBody.model = modelName;
            }

            // --- ** Stricter System Prompt ** ---
            const systemPrompt = `You are an expert AI assistant generating educational MCQs.
Generate exactly ${numQuestions} questions based on the user's prompt.
**ULTRA-CRITICAL INSTRUCTION:** YOU MUST output ONLY a single, valid JSON array string. ABSOLUTELY NO other text, introductions, explanations, comments, apologies, or markdown formatting (like \`\`\`) should be present in your response. YOUR RESPONSE MUST START *EXACTLY* WITH '[' AND END *EXACTLY* WITH ']'.
Respond ONLY in English.
Each object in the array MUST follow this exact format:
{
  "question": "Question text (Use valid MathJax LaTeX: $inline$ or $$display$$).",
  "options": ["Option A (LaTeX ok)", "Option B", "Option C", "Option D"],
  "correctAnswerIndex": N (0-based index),
  "explanation": "Explanation (LaTeX ok). If PYQ, state source."
}
Example of a perfect response for numQuestions=1:
[{"question":"Calculate $e^{i\\pi}$","options":["1","-1","i","-i"],"correctAnswerIndex":1,"explanation":"Euler's identity states $e^{i\\theta} = \\cos{\\theta} + i\\sin{\\theta}$. So, $e^{i\\pi} = \\cos{\\pi} + i\\sin{\\pi} = -1 + 0i = -1$."}]
Adhere strictly to generating only the JSON array string. Do not add ANY extra characters or text. Provide real PYQs if requested and possible, otherwise generate relevant questions. Verify accuracy.`;

            const userQuery = `Generate ${numQuestions} MCQs based on: "${prompt}". Follow ALL formatting instructions precisely.`;

            // Calculate max_tokens (same as before)
            const estimatedTokensPerQuestion = 250;
            const buffer = 500;
            const calculatedMaxTokens = (estimatedTokensPerQuestion * numQuestions) + buffer;
            const maxTokensLimit = 4000;
            const max_tokens = Math.min(calculatedMaxTokens, maxTokensLimit);

            // Add messages and parameters to request body
            requestBody.messages = [ { role: "system", content: systemPrompt }, { role: "user", content: userQuery } ];
            requestBody.max_tokens = max_tokens;
            // requestBody.temperature = 0.5; // Consider lowering temperature slightly
            requestBody.stream = false;

            // Execute API Call
            try {
                console.log(`Sending request to ${providerName}:`, apiUrl);
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(requestBody),
                    // signal: AbortSignal.timeout(60000) // Optional: 60s timeout
                });
                console.log(`${providerName} Response status:`, response.status, response.statusText);

                if (!response.ok) {
                    // ... (Error handling for !response.ok remains the same) ...
                     let errorDetails = `${providerName} API Error: ${response.status} ${response.statusText}`; try { const errorData = await response.json(); console.error(`${providerName} API Error Data:`, errorData); errorDetails = `${providerName} API Error (${response.status}): ${errorData?.error?.message || errorData?.message || response.statusText}`; if (response.status === 401) errorDetails += " (Invalid API Key?)"; if (response.status === 429) errorDetails += " (Rate Limit Exceeded?)"; if (response.status === 400 && errorData?.error?.code === 'model_not_found') errorDetails += " (Model Not Found or Invalid)"; if (response.status >= 500) errorDetails += " (Server Error)"; } catch (e) { console.error("Could not parse error response JSON:", e); } throw new Error(errorDetails);
                }

                const data = await response.json();

                if (!data.choices || data.choices.length === 0 || !data.choices[0].message || !data.choices[0].message.content) {
                    const finishReason = data.choices?.[0]?.finish_reason;
                    if (finishReason === 'length') { throw new Error(`Invalid response from ${providerName}: Response was truncated (finish_reason: length). Try requesting fewer questions or check model's context limits.`); }
                    throw new Error(`Invalid response structure from ${providerName}: No usable content found.`);
                }

                const aiContent = data.choices[0].message.content; // Don't trim here yet, check raw first

                // Use the helper function to parse and validate (includes check for brackets)
                return parseAndValidateApiResponse(aiContent, numQuestions);

            } catch (error) {
                console.error(`Error fetching/processing questions from ${providerName}:`, error);
                displayError(customizationError, `Failed to get questions: ${error.message}. Please check the browser console (F12) for details, especially the 'Raw AI Content' log. Consider trying a different model (if using OpenRouter), adjusting the prompt, or requesting fewer questions.`);
                return null; // Indicate failure
            } finally {
                 loadingIndicator.classList.add('hidden-element');
                 startQuizButton.disabled = false;
            }
        }


        // --- Quiz Logic Functions (typesetMathJax, displayQuestion, selectAnswer, showExplanation, highlightAnswer, disableOptions, enableOptions, startNewQuiz, showResults - Same as before) ---
        async function typesetMathJax(elements) { if (window.MathJax && window.MathJax.typesetPromise) { try { return await window.MathJax.typesetPromise(elements); } catch(mathJaxError) { console.error("MathJax typesetting error:", mathJaxError); } } else { console.warn("MathJax not ready."); } }
        async function displayQuestion(index) { if (index < 0 || index >= currentQuestions.length) return; const questionData = currentQuestions[index]; questionTextElement.textContent = questionData.question; optionsContainer.innerHTML = ''; feedbackTextElement.textContent = ''; feedbackTextElement.className = 'text-center font-semibold text-xl'; explanationArea.classList.add('hidden-element'); explanationTextElement.textContent = ''; questionData.options.forEach((option, i) => { const button = document.createElement('button'); button.textContent = option; button.classList.add('option-button', 'w-full', 'text-left', 'p-3', 'border', 'border-gray-300', 'rounded-md', 'shadow-sm', 'bg-white', 'hover:bg-gray-100', 'focus:outline-none', 'focus:ring-2', 'focus:ring-offset-1', 'focus:ring-indigo-400', 'transition', 'duration-150'); button.dataset.index = i; button.onclick = () => selectAnswer(index, i); optionsContainer.appendChild(button); }); const currentQuestionNum = index + 1; const totalQuestions = currentQuestions.length; progressTextElement.textContent = `Question ${currentQuestionNum} / ${totalQuestions}`; progressBarElement.style.width = `${(currentQuestionNum / totalQuestions) * 100}%`; await typesetMathJax([questionTextElement, optionsContainer]); const answered = userAnswers.find(ans => ans.questionIndex === index); prevButton.disabled = index === 0; nextButton.classList.toggle('hidden-element', index === totalQuestions - 1); finishButton.classList.toggle('hidden-element', index !== totalQuestions - 1); nextButton.disabled = !answered; finishButton.disabled = !answered; if (answered) { highlightAnswer(answered.selectedOptionIndex, answered.isCorrect, index); disableOptions(); await showExplanation(questionData); } else { enableOptions(); feedbackTextElement.textContent = ''; explanationArea.classList.add('hidden-element'); } }
        function selectAnswer(questionIndex, selectedOptionIndex) { if (userAnswers.some(ans => ans.questionIndex === questionIndex)) return; const questionData = currentQuestions[questionIndex]; const isCorrect = selectedOptionIndex === questionData.correctAnswerIndex; userAnswers.push({ questionIndex, selectedOptionIndex, isCorrect }); if (isCorrect) score++; highlightAnswer(selectedOptionIndex, isCorrect, questionIndex); disableOptions(); feedbackTextElement.textContent = isCorrect ? 'Correct!' : 'Incorrect!'; feedbackTextElement.classList.add(isCorrect ? 'text-green-600' : 'text-red-600'); feedbackTextElement.classList.remove(!isCorrect ? 'text-green-600' : 'text-red-600'); showExplanation(questionData); if (currentQuestionIndex === currentQuestions.length - 1) finishButton.disabled = false; else nextButton.disabled = false; }
        async function showExplanation(questionData) { if (questionData.explanation) { explanationTextElement.textContent = questionData.explanation; explanationArea.classList.remove('hidden-element'); await typesetMathJax([explanationTextElement]); } else { explanationArea.classList.add('hidden-element'); } }
        function highlightAnswer(selectedIndex, isCorrect, questionIndex) { const buttons = optionsContainer.querySelectorAll('button'); const correctIndex = currentQuestions[questionIndex].correctAnswerIndex; buttons.forEach((button, i) => { button.classList.remove('selected-answer', 'correct-answer', 'incorrect-answer', 'hover:bg-gray-100', 'opacity-80'); if (i === selectedIndex) { button.classList.add(isCorrect ? 'correct-answer' : 'incorrect-answer'); } else if (i === correctIndex && !isCorrect) { button.classList.add('correct-answer', 'opacity-80'); } }); }
        function disableOptions() { optionsContainer.querySelectorAll('button').forEach(button => { button.disabled = true; button.classList.add('opacity-75', 'cursor-not-allowed'); button.classList.remove('hover:bg-gray-100'); }); }
        function enableOptions() { optionsContainer.querySelectorAll('button').forEach(button => { button.disabled = false; button.classList.remove('opacity-75', 'cursor-not-allowed', 'correct-answer', 'incorrect-answer', 'opacity-80'); button.classList.add('hover:bg-gray-100'); }); }
        async function startNewQuiz(prompt, num) { hideError(customizationError); quizSettings = { provider: selectedProvider, model: modelName, prompt, numQuestions: num }; const questions = await fetchQuestions(prompt, num); if (questions && questions.length > 0) { currentQuestions = questions; currentQuestionIndex = 0; userAnswers = []; score = 0; showPage('quiz-page'); await displayQuestion(currentQuestionIndex); } else { console.error("Failed to start quiz."); } }
        function showResults() { finalScoreElement.textContent = `${score} / ${currentQuestions.length}`; showPage('results-page'); }

        // --- Event Listeners (Same as before) ---
        startQuizButton.addEventListener('click', () => { hideError(customizationError); const prompt = questionPromptInput.value.trim(); const num = parseInt(numQuestionsInput.value, 10); let isValid = true; if (!prompt) { displayError(customizationError, "Please enter a question prompt."); questionPromptInput.focus(); isValid = false; } if (isNaN(num) || num < 1 || num > 25) { displayError(customizationError, "Number of questions must be between 1 and 25."); numQuestionsInput.focus(); isValid = false; } if (isValid) startNewQuiz(prompt, num); });
        backToSetupButton.addEventListener('click', () => { showPage('setup-page'); hideError(setupError); hideError(customizationError); });
        prevButton.addEventListener('click', () => { if (currentQuestionIndex > 0) displayQuestion(--currentQuestionIndex); });
        nextButton.addEventListener('click', () => { if (currentQuestionIndex < currentQuestions.length - 1) displayQuestion(++currentQuestionIndex); });
        finishButton.addEventListener('click', () => { if (currentQuestionIndex === currentQuestions.length - 1) showResults(); });
        exitQuizButton.addEventListener('click', () => { if (confirm("Exit quiz? Progress lost.")) { showPage('customization-page'); currentQuestions = []; userAnswers = []; score = 0; hideError(customizationError); } });
        restartQuizButton.addEventListener('click', () => { if (quizSettings.prompt && quizSettings.numQuestions > 0) { selectedProvider = quizSettings.provider; modelName = quizSettings.model; apiProviderSelect.value = selectedProvider; updateSetupUI(); if (selectedProvider === 'openrouter') openRouterModelInput.value = modelName; questionPromptInput.value = quizSettings.prompt; numQuestionsInput.value = quizSettings.numQuestions; showPage('customization-page'); setTimeout(() => startNewQuiz(quizSettings.prompt, quizSettings.numQuestions), 50); } else { console.error("Cannot restart, previous settings missing."); showPage('customization-page'); } });
        newQuizButton.addEventListener('click', () => { showPage('customization-page'); hideError(customizationError); });

        // --- Initial Setup ---
        updateSetupUI();
        showPage('setup-page');

    </script>

</body>
</html>
